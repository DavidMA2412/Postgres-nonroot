apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: gitcheckouttest
spec:
  params:
  - name: buildrevision
  - name: appgiturl
  - name: configgiturl
  workspaces:
  - name: configsource
  steps:
  - name: git-checkout
    image: alpine/git:v2.26.2
    workingDir: "$(workspaces.configsource.path)"
    script: |
      #!/usr/bin/env sh
      set -e

      eval $(ssh-agent)
      ssh-add ~/.ssh/id_*

      git config --global user.email "tekton@tekton.dev"
      git config --global user.name "Tekton Pipeline"
      git config --global core.sshCommand 'ssh -o StrictHostKeyChecking=accept-new'

      git init
      #git remote add origin $(params.appgiturl)
      git remote add origin $(params.configgiturl)

      REVISION=$(params.buildrevision)
      #if [ -z "$(params.buildrevision)" ]
      #then
        #REVISION=$(git ls-remote $(params.appgiturl) refs/heads/master | awk '{print $1}')
      #fi
      echo Revision: $REVISION      
      echo REVISION=$REVISION > revision.txt

      #$REVISION | tee $(results.revision.path)
      #$REVISION | tee $(workspaces.configsource.path/revision)

      #git fetch --depth 1 origin $REVISION
      git fetch --depth 1 origin main
      #git checkout FETCH_HEAD
      git checkout main

      echo test > readme.md
      git add .
      git commit --allow-empty -m "[tekton] updating"
      git push origin main
---